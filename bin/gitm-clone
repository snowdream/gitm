#!/usr/bin/env node

var fs = require('fs');
var path = require('path')
var file = __dirname + '/repo.gitm';
var repo = JSON.parse(fs.readFileSync('./repo.gitm'));
var gitm_execute = require('./gitm-execute');
console.warn(repo);

if (!repo) {
    console.warn("The file repo.gitm does not exist.");
    return;
}

if (!repo.repository && !repo.repositories) {
    console.warn("The file repo.gitm is not valid.");
    return;
}

if (repo.repository) {
    dealRepo(repo.repository, __dirname);
} else if (repo.repositories) {
    for (var i = 0, len = repo.repositories.length; i < len; i++) {
        dealRepo(repo.repositories[i], __dirname);
    }
}


function dealRepo(repo, dir) {
    if (!repo) {
        return;
    }

    gitm_execute.exec("git clone " + repo.url + " " + repo.name);

    if (repo.repositories) {
        try {
            if(!fs.existsSync(repo.name)){
                fs.mkdirSync(repo.name);
            }
            process.chdir(repo.name);
        }
        catch (err) {
            console.log('chdir: ' + err);
        }

        for (var i = 0, len = repo.repositories.length; i < len; i++) {
            dealRepo(repo.repositories[i]);
        }

        process.chdir(dir.toString());
    }
}

function isArray(obj) {
    return Object.prototype.toString.call(obj) == '[object Array]';
}

