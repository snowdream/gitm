#!/usr/bin/env node

var fs = require('fs');
var request = require('sync-request');
var program = require('commander');
var gitm_execute = require('./gitm-execute');

program
    .parse(process.argv);

var args = program.args;


var repo ;
if(!args.length){
    repo = JSON.parse(fs.readFileSync('./repo.gitm'));
}else if(args.length == 1){
    var res = request('GET', args[0]);
    repo = JSON.parse(res.getBody());
}else{
    console.error('invalid parameters.');
    process.exit(1);
}

console.warn("repo:");
console.warn(repo);

if (!repo) {
    console.warn("The file repo.gitm does not exist.");
    return;
}

if (!repo.repository && !repo.repositories) {
    console.warn("The file repo.gitm is not valid.");
    return;
}

if (repo.repository) {
    dealRepo(repo.repository, __dirname);
} else if (repo.repositories) {
    for (var i = 0, len = repo.repositories.length; i < len; i++) {
        dealRepo(repo.repositories[i], __dirname);
    }
}

function dealRepo(repo, dir) {
    if (!repo) {
        return;
    }

    gitm_execute.execSync("git clone " + repo.url + " " + repo.name +" --progress -v");

    if (repo.repositories) {
        try {
            if(!fs.existsSync(repo.name)){
                fs.mkdirSync(repo.name);
            }
            process.chdir(repo.name);
        }
        catch (err) {
            console.log('chdir: ' + err);
        }

        for (var i = 0, len = repo.repositories.length; i < len; i++) {
            dealRepo(repo.repositories[i]);
        }

        process.chdir(dir.toString());
    }
}

function isArray(obj) {
    return Object.prototype.toString.call(obj) == '[object Array]';
}

